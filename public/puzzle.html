<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChessU Puzzle</title>

  <!-- Chessboard CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; text-align: center; }
    .balance {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 5px;
      margin: 20px 0;
      text-align: center;
      font-size: 14px;
      color: #1976d2;
    }
    .puzzle-container {
      display: flex;
      gap: 30px;
      margin: 30px 0;
    }
    #board {
      width: 400px;
    }
    .puzzle-info {
      flex: 1;
    }
    .puzzle-info h2 {
      margin-top: 0;
      color: #555;
    }
    .info-item {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .info-item strong {
      color: #333;
    }
    .moves-display {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 5px;
      padding: 10px;
      margin: 15px 0;
      font-family: monospace;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 12px 30px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    .message {
      margin: 20px 0;
      padding: 15px;
      border-radius: 5px;
      font-size: 16px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .reward {
      margin: 20px;
      padding: 30px;
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      text-align: center;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .reward h3 {
      color: #856404;
      margin-bottom: 15px;
    }
    .qr-code {
      margin: 20px 0;
    }
    .qr-code img {
      max-width: 300px;
      border: 3px solid #333;
      border-radius: 8px;
    }
    .token-string {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 15px 0;
      word-break: break-all;
      font-family: monospace;
      font-size: 11px;
      color: #495057;
      max-height: 100px;
      overflow-y: auto;
    }
    .links {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
      text-align: center;
    }
    .links a {
      color: #1976d2;
      text-decoration: none;
      margin: 0 15px;
    }
    .links a:hover {
      text-decoration: underline;
    }
    .highlight-square {
      box-shadow: inset 0 0 0 4px yellow !important;
    }
    .selected-square {
      box-shadow: inset 0 0 0 4px blue !important;
    }
    .cheat-wrapper {
      display: inline;
      position: relative;
    }
    .cheat-trigger {
      /* No special styling - looks like normal text */
    }
    .cheat-tooltip {
      display: none;
      position: absolute;
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 5px;
      padding: 8px 12px;
      margin-top: 5px;
      top: 25px;
      left: 0;
      font-size: 13px;
      color: #856404;
      z-index: 1000;
      white-space: nowrap;
    }
    .cheat-wrapper:hover .cheat-tooltip {
      display: block;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .puzzle-container {
        flex-direction: column;
        gap: 20px;
      }
      #board {
        width: 100%;
        max-width: 400px;
      }
      .container {
        padding: 15px;
      }
      .reward {
        margin: 10px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ôüÔ∏è ChessU Puzzle Challenge</h1>

    <div class="balance" id="balance">
      Loading puzzle pot balance...
    </div>

    <div id="message"></div>

    <div class="puzzle-container">
      <div id="board"></div>
      <div class="puzzle-info">
        <h2>Puzzle Info</h2>
        <div class="info-item" style="background: #e3f2fd; border-left: 4px solid #1976d2;">
          <strong style="font-size: 16px;">Instructions:</strong><br>
          Find the <span class="cheat-wrapper">
            <span class="cheat-trigger" id="bestWord">best</span>
            <div class="cheat-tooltip" id="cheatTooltip">
              Next move: <strong id="solution">-</strong>
            </div>
          </span> move for <strong id="sideToMove">white</strong>!
        </div>
        <div class="info-item">
          <strong>Rating:</strong> <span id="rating">-</span>
          <a id="lichessLink" href="#" target="_blank" style="color: #1976d2; font-size: 13px; margin-left: 15px;">View on Lichess ‚Üí</a>
        </div>
        <div class="info-item">
          <strong>Themes:</strong> <span id="themes">-</span>
        </div>
        <div class="moves-display">
          <strong>Your moves:</strong><br>
          <span id="userMoves">None yet</span>
        </div>
        <div style="margin-top: 20px;">
          <button onclick="resetPuzzle()" class="secondary">Reset</button>
          <button onclick="loadNewPuzzle()" class="secondary">New Puzzle</button>
        </div>
      </div>
    </div>

    <div id="rewardModal" class="modal-overlay" onclick="closeRewardModal(event)">
      <div id="reward" class="reward" onclick="event.stopPropagation()">
        <h3>üéâ Congratulations!</h3>
        <p>You earned <strong id="rewardAmount"></strong> sats!</p>
        <p>Scan this QR code with your Cashu wallet:</p>
        <div class="qr-code">
          <img id="qrImage" src="" alt="Cashu Token QR Code">
        </div>
        <div style="margin: 20px 0;">
          <strong>Token:</strong>
          <div class="token-string" id="tokenString"></div>
          <button onclick="copyToken()" style="background: #2196F3; margin-top: 10px;">
            üìã Copy Token to Clipboard
          </button>
        </div>
        <div style="margin: 10px 0; font-size: 14px; color: #666;">
          <strong>Mint:</strong> <span id="mintUrl"></span>
        </div>
        <button onclick="closeRewardModal()">Try Another Puzzle</button>
      </div>
    </div>

    <div class="links">
      <a href="/">Home</a> |
      <a href="/donate.html">Donate to Puzzle Pot</a> |
      <a href="/api/balance" target="_blank">Check Balance (JSON)</a>
    </div>
  </div>

  <!-- jQuery (required by chessboard.js) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <!-- Chessboard.js -->
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <script>
    let board = null;
    let game = null;
    let currentPuzzle = null;
    let solutionIndex = 0; // Track position in solution sequence
    let userMoves = []; // Track all user moves made
    let selectedSquare = null; // For tap-to-select, tap-to-move

    // Highlight squares after opponent move
    function highlightMove(from, to) {
      // Remove previous highlights
      $('.square-55d63').removeClass('highlight-square');

      // Add highlight to from and to squares
      $('.square-' + from).addClass('highlight-square');
      $('.square-' + to).addClass('highlight-square');
    }

    // Clear all highlights
    function clearHighlights() {
      $('.square-55d63').removeClass('highlight-square');
    }

    // Update solution display to show only the user's next move
    function updateSolutionDisplay() {
      if (!currentPuzzle || solutionIndex >= currentPuzzle.solution.length) {
        document.getElementById('solution').textContent = '-';
        return;
      }

      // Show the current expected move (user's move at odd indices)
      const nextMove = currentPuzzle.solution[solutionIndex];
      document.getElementById('solution').textContent = nextMove;
    }

    // Load balance on page load
    async function loadBalance() {
      try {
        const response = await fetch('/api/balance');
        const data = await response.json();
        document.getElementById('balance').textContent = `üí∞ Puzzle Pot: ${data.total} sats (${data.activeMode} mode)`;
      } catch (err) {
        document.getElementById('balance').textContent = '‚ö†Ô∏è Could not load balance';
      }
    }

    // Load a new puzzle
    function closeRewardModal(event) {
      // Close modal if clicking outside or if no event (button click)
      if (!event || event.target.id === 'rewardModal') {
        document.getElementById('rewardModal').style.display = 'none';
        loadNewPuzzle();
      }
    }

    async function loadNewPuzzle() {
      try {
        showMessage('Loading puzzle...', 'info');
        document.getElementById('rewardModal').style.display = 'none';

        const response = await fetch('/api/puzzle');
        const puzzle = await response.json();

        currentPuzzle = puzzle;
        userMoves = [];
        solutionIndex = 0;
        selectedSquare = null;
        $('.square-55d63').removeClass('selected-square');

        // Load FEN directly from puzzle
        game = new Chess(puzzle.fen);

        // Play the first move (opponent's move) automatically
        const firstMove = puzzle.solution[0];
        const from = firstMove.substring(0, 2);
        const to = firstMove.substring(2, 4);
        const promotion = firstMove.length === 5 ? firstMove[4] : 'q';

        // Update UI - flip board if needed (before making move)
        const isWhiteToMove = puzzle.fen.split(' ')[1] === 'w'; // Check from initial FEN
        board.orientation(isWhiteToMove ? 'black' : 'white'); // Opponent plays first, so flip
        board.position(puzzle.fen); // Set initial position

        // Make and animate the opponent's first move
        game.move({
          from: from,
          to: to,
          promotion: promotion
        });

        board.move(`${from}-${to}`);
        solutionIndex = 1; // User's turn starts at index 1

        // Highlight the opponent's move
        setTimeout(() => highlightMove(from, to), 100);
        document.getElementById('rating').textContent = puzzle.rating;
        document.getElementById('themes').textContent = puzzle.themes.join(', ') || 'None';
        document.getElementById('sideToMove').textContent = isWhiteToMove ? 'white' : 'black';
        document.getElementById('lichessLink').href = `https://lichess.org/training/${puzzle.id}`;
        document.getElementById('userMoves').textContent = 'None yet';

        // Update solution display to show user's next move
        updateSolutionDisplay();

        hideMessage();
      } catch (err) {
        showMessage('Failed to load puzzle: ' + err.message, 'error');
      }
    }

    // Handle piece move (called by onSquareClick)
    function onDrop(source, target) {
      // Clear highlights from opponent's previous move
      clearHighlights();

      // Check if puzzle is complete
      if (solutionIndex >= currentPuzzle.solution.length) {
        return 'snapback';
      }

      // Get expected move (user's moves are at odd indices: 1, 3, 5...)
      const expectedMove = currentPuzzle.solution[solutionIndex];
      const userMove = source + target;

      // Check for promotion (5 characters means promotion piece is included)
      let promotionPiece = 'q'; // default to queen
      let expectedMoveBase = expectedMove;

      if (expectedMove.length === 5) {
        // Promotion move like "e7e8q"
        expectedMoveBase = expectedMove.substring(0, 4);
        promotionPiece = expectedMove[4];
      }

      // Check if move matches expected move
      if (userMove !== expectedMoveBase) {
        console.log('Wrong move! Expected:', expectedMoveBase, 'Got:', userMove);
        showMessage('‚ùå Wrong move! Try again.', 'error');
        return 'snapback';
      }

      console.log('Correct move:', userMove);

      // Make the move with correct promotion piece
      const move = game.move({
        from: source,
        to: target,
        promotion: promotionPiece
      });

      if (move === null) {
        console.log('Move rejected by chess.js');
        return 'snapback';
      }

      // Track user's move (include promotion piece if applicable)
      const fullMove = expectedMove.length === 5 ? userMove + promotionPiece : userMove;
      userMoves.push(fullMove);
      solutionIndex++;
      updateMovesDisplay();

      // Check if puzzle is complete
      if (solutionIndex >= currentPuzzle.solution.length) {
        showMessage('‚úÖ Correct! Submitting solution...', 'success');
        setTimeout(submitSolution, 500);
        return;
      }

      // Play opponent's response automatically
      setTimeout(() => {
        const opponentMove = currentPuzzle.solution[solutionIndex];
        const from = opponentMove.substring(0, 2);
        const to = opponentMove.substring(2, 4);
        const promotion = opponentMove.length === 5 ? opponentMove[4] : 'q';

        game.move({
          from: from,
          to: to,
          promotion: promotion
        });

        // Animate opponent's move
        board.move(`${from}-${to}`);
        solutionIndex++;

        // Highlight the opponent's move
        highlightMove(from, to);

        // Update solution display for next user move
        updateSolutionDisplay();

        // Check if puzzle is complete after opponent's move
        if (solutionIndex >= currentPuzzle.solution.length) {
          showMessage('‚úÖ Puzzle complete! Submitting...', 'success');
          setTimeout(submitSolution, 500);
        }
      }, 300);
    }

    // Handle square click for tap-to-select, tap-to-move
    function onSquareClick(square) {
      console.log('Clicked square:', square, '| Currently selected:', selectedSquare);

      const piece = game.get(square);
      console.log('Piece at', square, ':', piece);

      // If no square selected
      if (!selectedSquare) {
        // Only select if there's a piece and it's the player's turn
        if (piece && piece.color === game.turn()) {
          $('.square-55d63').removeClass('selected-square');
          selectedSquare = square;
          $('.square-' + square).addClass('selected-square');
          console.log('Selected piece at', square);
        } else {
          console.log('Cannot select - no piece or not your turn');
        }
        return;
      }

      // If tapping your own piece (whether same or different)
      if (piece && piece.color === game.turn()) {
        if (selectedSquare === square) {
          // Tapping same selected piece - do nothing (stay selected)
          console.log('Tapped already-selected piece - keeping selection');
          return;
        } else {
          // Tapping different own piece - switch selection
          $('.square-55d63').removeClass('selected-square');
          selectedSquare = square;
          $('.square-' + square).addClass('selected-square');
          console.log('Switched selection to', square);
          return;
        }
      }

      // Attempting to move to empty square or capture opponent's piece
      const source = selectedSquare;
      const target = square;
      console.log('Attempting move from', source, 'to', target);

      $('.square-55d63').removeClass('selected-square');
      selectedSquare = null; // Clear selection

      // Animate the move first
      board.move(`${source}-${target}`);

      // Then validate
      const result = onDrop(source, target);

      // If move failed, reset board position (will snap back)
      if (result === 'snapback') {
        console.log('Move failed - snapback');
        board.position(game.fen());
      }
    }

    function updateMovesDisplay() {
      const movesEl = document.getElementById('userMoves');
      if (userMoves.length === 0) {
        movesEl.textContent = 'None yet';
      } else {
        movesEl.textContent = userMoves.join(', ');
      }
    }

    async function submitSolution() {
      showMessage('Generating reward...', 'info');

      try {
        const response = await fetch('/api/puzzle/solve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            puzzleId: currentPuzzle.id,
            moves: userMoves
          })
        });

        const data = await response.json();

        if (response.ok) {
          // Success! Show reward modal
          hideMessage();
          document.getElementById('rewardModal').style.display = 'flex';
          document.getElementById('rewardAmount').textContent = data.reward;
          document.getElementById('qrImage').src = data.qrCode;
          document.getElementById('tokenString').textContent = data.token;
          document.getElementById('mintUrl').textContent = data.mint;

          // Update balance
          loadBalance();
        } else {
          showMessage(`‚úó ${data.error}`, 'error');

          // If rate limited, reset the puzzle so user can try again
          if (response.status === 429) {
            setTimeout(() => {
              resetPuzzle();
            }, 1000);
          }
        }
      } catch (err) {
        showMessage(`‚úó Network error: ${err.message}`, 'error');
      }
    }

    function resetPuzzle() {
      if (!currentPuzzle) return;

      // Reset to puzzle starting position
      game = new Chess(currentPuzzle.fen);

      // Set initial position
      const isWhiteToMove = currentPuzzle.fen.split(' ')[1] === 'w';
      board.orientation(isWhiteToMove ? 'black' : 'white');
      board.position(currentPuzzle.fen);

      // Play the first move (opponent's move) automatically
      const firstMove = currentPuzzle.solution[0];
      const from = firstMove.substring(0, 2);
      const to = firstMove.substring(2, 4);
      const promotion = firstMove.length === 5 ? firstMove[4] : 'q';

      game.move({
        from: from,
        to: to,
        promotion: promotion
      });

      // Animate the opponent's first move
      board.move(`${from}-${to}`);

      // Highlight the opponent's move
      setTimeout(() => highlightMove(from, to), 100);

      userMoves = [];
      solutionIndex = 1; // User's turn starts at index 1
      selectedSquare = null;
      $('.square-55d63').removeClass('selected-square');
      updateMovesDisplay();
      updateSolutionDisplay();
      hideMessage();
    }

    async function copyToken() {
      const tokenString = document.getElementById('tokenString').textContent;
      try {
        await navigator.clipboard.writeText(tokenString);
        showMessage('‚úì Token copied to clipboard!', 'success');
      } catch (err) {
        showMessage('‚úó Failed to copy. Please copy manually.', 'error');
      }
    }

    function showMessage(msg, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = msg;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
    }

    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }

    // Initialize board (no dragging - tap only)
    const config = {
      draggable: false,
      pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    };
    board = Chessboard('board', config);

    // Handle all clicks on the board - tap to select, tap to move
    $('#board').on('click', '.square-55d63', function(e) {
      let square = $(this).attr('data-square');
      if (!square) {
        square = $(this).closest('.square-55d63').attr('data-square');
      }
      if (square) {
        onSquareClick(square);
      }
    });

    // Load initial puzzle and balance
    loadBalance();
    loadNewPuzzle();
  </script>
</body>
</html>
